SUBSYSTEM!="block", GOTO="end_mpath"
KERNEL=="nbd*", GOTO="end_mpath"
KERNEL=="td[a-z]*", GOTO="end_mpath"

IMPORT{db}="DM_MULTIPATH_DEVICE_PATH"
ACTION=="add",  ENV{DM_MULTIPATH_DEVICE_PATH}=="1", GOTO="count_mpath"
ACTION=="remove", ENV{DM_MULTIPATH_DEVICE_PATH}=="1",  GOTO="count_mpath"
IMPORT{db}="DM_ACTION"
ACTION=="change", ENV{DM_ACTION}=="PATH_REINSTATED", GOTO="count_mpath"
ACTION=="change", ENV{DM_ACTION}=="PATH_FAILED", GOTO="count_mpath"
GOTO="end_mpath"

LABEL="count_mpath"
ACTION=="add|change", PROGRAM=="/sbin/dmsetup info -c -o name --noheadings -j %M -m %m", RESULT=="?*", SYMLINK+="disk/by-scsid/%c/mapper"
ACTION=="*", RUN+="/opt/xensource/libexec/kickpipe mpathcount"
LABEL="end_mpath"
